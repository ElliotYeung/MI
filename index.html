<!DOCTYPE html>
<html>
<head>
    <title>webMIS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/lib/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style media="screen" type="text/css">
        body {
            background-color: #121010;
            color: white;
        }

        #imageCanvas {
            background-color:black;
            width: 400px;
            height: 400px;
            margin: 25px;
            align-content: inherit;
        }
        #undoCanvas {
            background-color:black;
            width: 400px;
            height: 400px;
            margin: 25px;
            align-content: inherit;
        }

        table {
            border: 1px solid white;
        }

.button {
    position: relative;
    background-color: #121010;
    border: none;
    font-size: 18px;
    color: #FFFFFF;
    padding: 5px;
    width: 200px;
    text-align: center;
    -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
    text-decoration: none;
    overflow: hidden;
    cursor: pointer;
}

.button:hover {
    background-color: #FF0000;
    color: white;
}



   h1.web { margin:0; padding:0; color:#FF0000;font-weight:bold;font-family:Tahoma;font-size:40px }   
    span.MIS { margin:0; padding:0; color:white;font-weight:bold;font-family:Calibri;font-size:60px }
    h2.title{margin:0; padding:0;}

    </style>
</head>
<body>
    <div class="w3-container">
        <h1 class="web">web<span class="MIS">MIS</span></h1>
        <h2 class="title" style="color:#9a9797">Web-based Medical Imaging Software</h2>
        <div style="background-color:black; float:left; width:1275px;height:450px;border:1px solid #000;">
            <div align="center" id="paint">
                    <canvas id="imageCanvas"></canvas>


                    <canvas id="undoCanvas"></canvas>
                </div>
        </div>
        <!--<button onclick="grayscale()">Contrast Image</button>-->

        <table style="float:right">
            <tr>
                <th style="font-size:28px">Tools</th>
            </tr>
            <tr>
                <td><button class="button" onclick="threshold()"><i class="w3-margin-left fa fa-cog"></i><br />Threshold Image</button></td>
            </tr>
            <tr>
                <td><button class="button" onclick="imbinarize()"><i class="w3-margin-left fa fa-adjust"></i><br />Binarize Image</button></td>
                
            </tr>
            <tr>
                <td><button class="button" onclick="draw()"><i class="w3-margin-left fa fa-pencil"></i><br />Draw</button></td>
            </tr>
            <tr>
                <td><button class="button" onclick="undo()"><i class="w3-margin-left fa fa-undo"></i><br />Undo</button></td>
            </tr>
            <tr>
                <td>Sharpen:<input type=range id=mix min=0 max=100 value=20 onchange="update()"></td>
            </tr>
        </table>

        <div align="center">

        </div>
        <div style="float:left">
            <p>Choose Image to edit:</p>
            <input class="fa fa-upload" aria-hidden="true" type="file" id="imageLoader" name="imageLoader" />
        </div>

        </div>
</body>
</html>
<script>
    //Load Image onto Canvas
    var imageLoader = document.getElementById('imageLoader');
    imageLoader.addEventListener('change', handleImage, false);
    var canvas = document.getElementById('imageCanvas');
    var clone = document.getElementById('undoCanvas');
    var ctx_clone = clone.getContext('2d');
    var ctx = canvas.getContext('2d');
    var browsedimagedata = [];
    var uploadcount = 0;
    function handleImage(e) {
        var reader = new FileReader();
        reader.onload = function (event) {
            var img = new Image();
            img.onload = function () {
                canvas.width = img.width;
                clone.width = img.width;
                canvas.height = img.height;
                clone.height = img.height;
                ctx.drawImage(img, 0, 0);
                ctx_clone.drawImage(img, 0, 0);
            }
            img.src = event.target.result;
            browsedimagedata.push(img.src);
            uploadcount++;
        }
        reader.readAsDataURL(e.target.files[0]);
    }
    //test
    //offScreen = document.createElement('canvas'),
    // offctx = offScreen.getContext('2d'),
    /// as we need pixel access to apply convolution we
    /// need to get around CORS:
    // img.crossOrigin = 'anonymous';
    /// when image is loaded step-down the downscaling
    // img.onload = resize;
    /// sharpen image:
    /// USAGE:
    ///    sharpen(context, width, height, mixFactor)
    ///  mixFactor: [0.0, 1.0]
    //binarization of image (threshold)


    //Drawing function
    function draw() {


               var letsdraw = false;

 
            var canvasOffset = $('#imageCanvas').offset();

            $('#imageCanvas').mousemove(function (e) {
                if (letsdraw === true) {
                    ctx.lineTo(e.pageX - canvasOffset.left, e.pageY - canvasOffset.top);
                    ctx.stroke();
                }
            });

            $('#imageCanvas').mousedown(function (e) {
                // setup all of the properties for your line on mousedown, not mousemove
                letsdraw = true;
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 10;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(e.pageX - canvasOffset.left, e.pageY - canvasOffset.top);
            });

            $(window).mouseup(function () {
                // bind to the window mouse up, that way if you mouse up and you're not over 
                // the canvas you'll still get the release of the drawing.
                letsdraw = false;
            });
        };
        //$('#imageCanvas').mousedown(function (e) {
        //    var mouseX = e.pageX - this.offsetLeft;
        //    var mouseY = e.pageY - this.offsetTop;

        //    paint = true;
        //    addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
        //    redraw();
        //});

        //$('#imageCanvas').mousemove(function (e) {
        //    if (paint) {
        //        addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
        //        redraw();
        //    }
        //});

        //$('#imageCanvas').mouseup(function (e) {
        //    paint = false;
        //});

        //$('#imageCanvas').mouseleave(function (e) {
        //    paint = false;
        //});

        //var clickX = new Array();
        //var clickY = new Array();
        //var clickDrag = new Array();
        //var paint;

        //function addClick(x, y, dragging) {
        //    clickX.push(x);
        //    clickY.push(y);
        //    clickDrag.push(dragging);
        //}

        //function redraw() {
        //    //ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clears the canvas

        //    ctx.strokeStyle = "rgba(247, 2, 2, 0.66)";
        //    ctx.lineJoin = "round";
        //    ctx.lineWidth = 30;
           
           

        //    for (var i = 0; i < clickX.length; i++) {
        //        ctx.beginPath();
        //        if (clickDrag[i] && i) {
        //            ctx.moveTo(clickX[i - 1], clickY[i - 1]);
        //        } else {
        //            ctx.moveTo(clickX[i] - 1, clickY[i]);
        //        }
        //        ctx.lineTo(clickX[i], clickY[i]);
        //        ctx.closePath();
        //        ctx.stroke();
        //    }
        //}


    
    function imbinarize() {
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var data = imageData.data;
        for (var i = 0; i < data.length; i += 4) {
            var brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
            // red
            data[i] = brightness;
            // green
            data[i + 1] = brightness;
            // blue
            data[i + 2] = brightness;
        }
        for (var i = 0; i < data.length; i++) {
            if (data[i] < 128) {
                data[i] = 0;

            }
            else {
                data[i] = 255;

            }
        }
        // overwrite original image
        ctx.putImageData(imageData, 0, 0);
        if (logtoprocesslist == true) {
            processingfunctions.push(imbinarize);
        }
    }
    var sharpenparameters = []; // gloabl sharpen image function parameter storage for undo functionality.
    var sharpencall=0; // global sharpen call lets us know how many times the sharpen function has been called
    function sharpen() {

        var weights = [0, -1, 0, -1, 5, -1, 0, -1, 0],
            katet = Math.round(Math.sqrt(weights.length)),
            half = (katet * 0.5) | 0,
            dstData = ctx.ImageData(can.width, canvas.height),
            dstBuff = dstData.data,
            srcBuff = ctx.getImageData(0, 0, w, h).data,
            y = h;
        while (y--) {
            x = w;
            while (x--) {
                var sy = y,
                    sx = x,
                    dstOff = (y * w + x) * 4,
                    r = 0,
                    g = 0,
                    b = 0,
                    a = 0;
                for (var cy = 0; cy < katet; cy++) {
                    for (var cx = 0; cx < katet; cx++) {
                        var scy = sy + cy - half;
                        var scx = sx + cx - half;
                        if (scy >= 0 && scy < h && scx >= 0 && scx < w) {
                            var srcOff = (scy * w + scx) * 4;
                            var wt = weights[cy * katet + cx];
                            r += srcBuff[srcOff] * wt;
                            g += srcBuff[srcOff + 1] * wt;
                            b += srcBuff[srcOff + 2] * wt;
                            a += srcBuff[srcOff + 3] * wt;
                        }
                    }
                }
                dstBuff[dstOff] = r * 10 + srcBuff[dstOff] * (1 - 10);
                dstBuff[dstOff + 1] = g * 10 + srcBuff[dstOff + 1] * (1 - 10);
                dstBuff[dstOff + 2] = b * 10 + srcBuff[dstOff + 2] * (1 - 10)
                dstBuff[dstOff + 3] = srcBuff[dstOff + 3];
            }
        }
        ctx.putImageData(dstData, 0, 0);
        if (logtoprocesslist == true) {
            processingfunctions.push(sharpen);
            sharpenparameters.push(this.ctx, this.w, this.h, this.mix);
            sharpencall++;
        }
    }
    /// naive and non-efficient implementation of update, but
    /// do illustrate the impact of sharpen after a downsample
    function resize() {
        /// set canvas size proportional to original image
        canvas.height = canvas.width * (img.height / img.width);
        /// set off-screen canvas/sharpening source to same size
        offScreen.width = canvas.width;
        offScreen.height = canvas.height;
        /// step 1 in down-scaling
        var oc = document.createElement('canvas'),
            octx = oc.getContext('2d');
        oc.width = img.width * 0.5;
        oc.height = img.height * 0.5;
        octx.drawImage(img, 0, 0, oc.width, oc.height);
        /// step 2
        octx.drawImage(oc, 0, 0, oc.width * 0.5, oc.height * 0.5);
        /// draw final result to screen canvas
        ctx.drawImage(oc, 0, 0, oc.width * 0.5, oc.height * 0.5,
        0, 0, canvas.width, canvas.height);
        /// copy to off-screen to use as source for shapening
        offctx.drawImage(canvas, 0, 0);
        /// apply sharpening convolution
        update();
    }
    /// adjustable sharpening - update cached source
    function update() {
        ctx.drawImage(offScreen, 0, 0);
        sharpen(ctx, canvas.width, canvas.height, parseInt(mix.value) * 0.01);
    }
    //test
    //Contrast Image

    /*
    undo() is used to go back to the previous image state per function call.
    */

    function undo() {
        var imageData = ctx_clone.getImageData(0, 0, clone.width, clone.height);
        ctx.putImageData(imageData, 0, 0);

    }



    function grayscale() {
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var data = imageData.data;

        for (var i = 0; i < data.length; i += 4) {
            var brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
            // red
            data[i] = brightness;
            // green
            data[i + 1] = brightness;
            // blue
            data[i + 2] = brightness;
        }
        // overwrite original image
        ctx.putImageData(imageData, 0, 0);
        if (logtoprocesslist == true) {
            processingfunctions.push(grayscale);
        }


    }
    //Threshold Image
    function threshold() {
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var data = imageData.data;
        var factor = (259 * (30 + 255)) / (255 * (259 - 30));
        for (var i = 0; i < data.length; i += 4) {
            data[i] = factor * (data[i] - 128) + 128;
            data[i + 1] = factor * (data[i + 1] - 128) + 128;
            data[i + 2] = factor * (data[i + 2] - 128) + 128;
        }
        // overwrite original image
        ctx.putImageData(imageData, 0, 0);
        if (logtoprocesslist == true) {
            processingfunctions.push(threshold);
        }
    }
    function texture() {
        // convert the image to a texture
        var image = document.getElementById('imageLoader');
        var texture = canvas.texture(image);
        // apply the ink filter
        canvas.draw(texture).ink(0.25).update();
        // replace the image with the canvas
        image.parentNode.insertBefore(canvas, image);
        image.parentNode.removeChild(image);
        // if (logtoprocesslist == true) {
        //   processingfunctions.push(texture);
        //}
    }
</script>

